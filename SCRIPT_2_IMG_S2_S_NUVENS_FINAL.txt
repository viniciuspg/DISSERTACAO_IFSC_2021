/*
INSTITUTO FEDERAL DE SANTA CATARINA - IFSC
Campus Florianópolis
Departamento Acadêmico de Saúde e Serviços
Mestrado Profissional em Clima e Ambiente
Autor: Vinicius Paiva Gonçalves
Orientador: Dr. Eduardo Augusto Werneck Ribeiro
Data: 27/07/2021

Este script é um produto integrante da 
Dissertação apresentada ao Mestrado Profissional em Clima e Ambiente
do Campus Florianópolis do Instituto Federal de Santa Catarina para a 
obtenção do diploma de Mestre em Clima e Ambiente.
Link: https://code.earthengine.google.com/c8a524d19eee5f153eb441bab6e605fa
Link Github: https://github.com/viniciuspg/DISSERTACAO_IFSC_2021/blob/main/SCRIPT_2_IMG_S2_S_NUVENS_FINAL.txt

Título da dissertação:  UTILIZAÇÃO DE SENSORIAMENTO REMOTO PARA MAPEAMENTO DE ÁREAS INVASÃO POR Pinus sp. EM AMBIENTES DE RESTINGA:
Uma abordagem utilizando a série histórica do projeto MapBiomas e classificação GEOBIA de imagens captadas por drones

PRODUTO: SCRIPT 2 - EXPORTAR MOSAICO SENTINEL DOS MELHORES PIXELS (SEM NUVENS) PARA GOOGLE DRIVE 
 
 MODO DE UTILIZAÇÃO:
 1º PASSO: desenhe um retângulo (variável geometry) envolvendo sua área de interesse (AOI)
 no mapa, usando as ferramentas de geometria;

 2º PASSO: Definir coleção Sentinel, intervalo de datas e porcentagem de nuvens dos pixels;
 
 3º PASSO: Definir nomes para a pasta arquivo que será exportado.

 Importar imagem da coleção Sentinel INSTRUMENTO MSI (Multi Spectral Instrument):
 - Para nível de processamento L1-C: Reflectância no topo da atmosfera (TOA): usar 'COPERNICUS/S2'
       - Disponível a partir de 23/06/2015 (mais informações em https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S2)
 - Para nível de processamento L2-A: Reflectância na base da atmosfera ou de superfície (BOA): usar 'COPERNICUS/S2_SR'
      - Disponível a partir de 28/03/2017 (mais informaçõees em https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S2_SR)
*/


var collection = ee.ImageCollection('COPERNICUS/S2_SR') // busca todos os pixels das imagens Sentinel 2
  .filter(ee.Filter.lt("CLOUDY_PIXEL_PERCENTAGE", 20)) // filtra pixels com menos de than X% de nuvens, a partir dos metadados
  .filterDate('2019-02-05','2021-07-26') // escolhe apenas pixels entre o intervalo de datas aqu idefinido
  .filterBounds(geometry); // recorta imagem dentro da AOI.
  
print(collection); // gera uma lista JSON (JavaScript Object Notation) das imagens (e seus metadados) cujos filtros são mostrados no COONSOLE na janela ao lado direito
  
//// até agora isso foi para localizar todas as imagens da coleção que atendem aos critérios - as mais recentes no topo. Para obter um belo mosaico de aspecto misto, 
// tente algumas das ferramentas para 'reduzir' estes para um pixel (ou faixas de pixels em uma pilha de camadas). 

var medianpixels = collection.median(); // Encontra o valor mediano de todos os pixels que satisfazem os critérios. 

var medianpixelsclipped = medianpixels.clip(geometry).divide(10000); // isso corta o resultado para que ele se encaixe perfeitamente em na AOI
                                                                  // e se divide de modo que valores fiquem entre 0 e 1      

//CENTRALIZANDO MAPA NA REGIÃO DE INTERESSE
Map.centerObject(geometry, 10);


// Visualizar o mosaico como uma imagem colorida natural.
// Seleccionar composição ou bandas desejadas,entre colchetes usando aspas simples, separado por vírgula.
//        EXEMPLOS:
//             ['B12', 'B11', 'B4'] --> COR VERDADEIRA RGB CLARA (20M)
//             ['B4', 'B3', 'B2'] --> COR VERDADEIRA RGB ESCURA (10M)
//             ['B8', 'B4', 'B3'] --> FALSA COR VERMELHA (10M)
//             ['B4', 'B8', 'B3'] --> FALSA COR VERDE (10M)
//   - Bandas disponíveis para TOA (VER https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S2#bands)
//   - Bandas disponíveis para BOA (VER https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S2_SR#bands)
Map.addLayer(medianpixelsclipped, {bands: ['B12', 'B11', 'B4'], min: 0, max: 1, gamma: 1.5}, 'Sentinel_2 mosaic_B12_B11_B4');
Map.addLayer(medianpixelsclipped, {bands: ['B4', 'B3', 'B2'], min: 0, max: 1, gamma: 1.5}, 'Sentinel_2 mosaic_B4_B3_B2');
Map.addLayer(medianpixelsclipped, {bands: ['B8', 'B4', 'B3'], min: 0, max: 1, gamma: 1.5}, 'Sentinel_2 mosaic_B8_B4_B3');
Map.addLayer(medianpixelsclipped, {bands: ['B4', 'B8', 'B3'], min: 0, max: 1, gamma: 1.5}, 'Sentinel_2 mosaic_B4_B8_B3');

// Exportar o mosaico o para seu Google Drive como uma imagem tiff para uso no QGIS
// Exportar a imagem, especificando a composição de bandas, escala e a região
//    - em image, especificar a composição de bandas entre parênteses, cada banda entre aspas, separadas por vírgula, p.ex para mesclar 3 bandas ("B8", "B4", "B3") ; para mesclar todas as bandas B, usar ("B.+")
//    - em description, digitar o nome do arquivo
//    - em scale, definir o tamanho do pixel de saída, em metros (varia entre 10  e 60 metros, conforme a banda)
//    - em region, definir a extensão:
//         - geometry --> para exportar a área do retângulo desenhado pelo usuário, ou;
Export.image.toDrive({
  image: medianpixelsclipped.select("B8", "B4", "B3"),
  description: 'MOSAICOS2_tbOA_lugar_aaaa_mm_dd_ATE_aaaa_mm_dd_bbb',
  scale: 10,
  maxPixels: 1e13,
  region: geometry,
  folder: 'GEE',
});

// FONTES CONSULTADAS:
//    - Canal EAMENA Project. Vídeo: 25_How to mosaic Sentinel 2 images with Google Earth Engine - disponível em <https://www.youtube.com/watch?v=YYFv3j2tE5U&t=4s>, acesso em 25 out. 2020.
//    - Forum Geographic Information Systems Stack Exchange, disponível em <https://gis.stackexchange.com/questions/300344/gee-exported-bands-must-have-compatible-data-types-found-inconsistent-types>, acesso em 25 out. 2020.
//    - Ajuda do GEE <https://developers.google.com/earth-engine/guides/exporting:> , acesso em 25 out. 2020.
